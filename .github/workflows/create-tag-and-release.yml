name: Create Tag and GitHub Release

on:
  workflow_run:
    workflows: ["Create zip for XCFrameworks"]
    branches: ["release-*"]  # Add this if missing
    types:
      - completed

permissions:
  contents: write  

jobs:
  create_tag_release:
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download zip files
        uses: actions/download-artifact@v4
        with:
          name: zip-files
          path: zip-files

      - name: Download Release Tag
        uses: actions/download-artifact@v4
        with:
          name: release-tag
          path: .

      - name: Set NEW_TAG from file
        run: echo "NEW_TAG=$(cat new_tag.txt)" >> $GITHUB_ENV

      - name: Create Git Tag
        run: |
          git tag $NEW_TAG
          git push origin $NEW_TAG

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.NEW_TAG }}
          name: Release ${{ env.NEW_TAG }}
          files: zip-files/*.zip  # Fixing file selection
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: true
          prerelease: true
